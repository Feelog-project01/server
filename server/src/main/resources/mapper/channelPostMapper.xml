<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.app.feelog.mapper.ChannelPostMapper">

    <!-- INSERT -->
    <insert id="insertChannelPost" parameterType="ChannelPostVO">
        INSERT INTO tbl_channel_post (
        id,
        post_type,
        post_file_path,
        post_file_name,
        post_file_size,
        member_id,
        channel_id
        )
        VALUES (
        #{id},
        #{postType},
        #{postFilePath},
        #{postFileName},
        #{postFileSize},
        #{memberId},
        #{channelId}
        )
    </insert>

    <!-- SELECT (수정용 단건 조회) -->
    <select id="selectChannelPostById" resultType="ChannelPostVO">
        SELECT
            id,
            post_type,
            post_file_path,
            post_file_name,
            post_file_size,
            member_id,
            channel_id
        FROM tbl_channel_post
        WHERE id = #{id}
    </select>

    <!-- UPDATE -->
    <update id="updateChannelPost" parameterType="ChannelPostVO">
        update tbl_channel_post
        set
            post_type = #{postType},
            post_file_path = #{postFilePath},
            post_file_name = #{postFileName},
            post_file_size = #{postFileSize},
            member_id = #{memberId},
            channel_id = #{channelId}
        where id = #{id}
    </update>

    <select id="findById" parameterType="long" resultType="ChannelPostVO">
        SELECT cp.*
        FROM tbl_channel_post cp
                 JOIN tbl_post p ON cp.id = p.id
        WHERE cp.id = #{id}
    </select>

    <select id="findRecentChannelPosts" resultType="com.app.feelog.domain.dto.ChannelPostSearchDTO">
        SELECT
            cp.id,
            p.post_title AS title,
            CONCAT(cp.post_file_path, '/', cp.post_file_name) AS thumbnailUrl,
            m.member_nickname AS nickname,
            p.created_date,
            cp.post_type AS postType,
            p.post_status,
            (
                SELECT GROUP_CONCAT(t.contents)
                FROM tbl_channel_post_tag ct
                         JOIN tbl_tag t ON ct.id = t.id
                WHERE ct.channel_post_id = cp.id
                  AND t.tag_status = 'ACTIVE'
            ) AS tags
        FROM tbl_channel_post cp
                 JOIN tbl_post p ON cp.id = p.id
                 JOIN tbl_member m ON cp.member_id = m.id
        WHERE p.post_status = '정상'
        ORDER BY p.created_date DESC
        LIMIT 10
    </select>

    <select id="searchChannelPosts" resultType="com.app.feelog.domain.dto.ChannelPostSearchDTO">
        SELECT
            p.id,
            p.post_title AS title,
            p.post_content AS content,
            m.member_nickname AS nickname,
            CONCAT(m.member_file_path, '/', m.member_file_name) AS memberProfileImage,
            cp.post_type AS postType,
            CONCAT(cp.post_file_path, '/', cp.post_file_name) AS thumbnailUrl,
            p.created_date AS createdDate,
            (
                SELECT GROUP_CONCAT(t.contents)
                FROM tbl_channel_post_tag pt
                         JOIN tbl_tag t ON pt.id = t.id
                WHERE pt.channel_post_id = p.id
                  AND t.tag_status = 'ACTIVE'
            ) AS tags
        FROM tbl_post p
                 JOIN tbl_channel_post cp ON p.id = cp.id
                 JOIN tbl_member m ON cp.member_id = m.id
                 LEFT JOIN tbl_channel_post_tag pt ON p.id = pt.channel_post_id
                 LEFT JOIN tbl_tag t ON pt.id = t.id AND t.tag_status = '정상'
        WHERE p.post_status = '정상'
          AND (
            p.post_title LIKE CONCAT('%', #{keyword}, '%')
                OR p.post_content LIKE CONCAT('%', #{keyword}, '%')
                OR t.contents LIKE CONCAT('%', #{keyword}, '%')
            )
        GROUP BY p.id, p.post_title, m.member_nickname, m.member_file_path, m.member_file_name, cp.post_file_path, cp.post_file_name, cp.post_type, p.created_date
        ORDER BY p.created_date DESC
        LIMIT 5
    </select>

</mapper>