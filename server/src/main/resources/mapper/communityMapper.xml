<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.app.feelog.mypage.mapper.CommunityMapper">

    <select id="getCommunityPostListTotalCount" resultType="_int">
        select   count(*)
        from     tbl_community_post cp
                join     tbl_channel c
                    on   c.id   =   cp.channel_id
                join     tbl_post p
                    on   cp.id   =  p.id
        where    c.channel_url = #{channelUrl}
        and      p.post_status = '정상'
    </select>

    <select id="getCommunityPostList" resultType="communityPostVO">
        select   p.id,
                 p.post_content,
                 p.created_date,
                 p.updated_date,
                 cp.member_id,
                 cp.channel_id
        from     tbl_community_post cp
                     join     tbl_channel c
                              on   c.id   =   cp.channel_id
                     join     tbl_post p
                              on   cp.id   =  p.id
        where    c.channel_url = #{channelUrl}
          and    p.post_status = '정상'
        order    by  p.id desc
    </select>

    <select id="getCommunityPostFiles"  resultType="communityPostFileVO">
        select f.id,
               f.file_path,
               f.file_name,
               cpf.post_id
        from   tbl_file f
        join   tbl_community_post_file cpf
        on     f.id          =    cpf.id
        where  cpf.post_id   = #{postId}
        and    f.file_status = '정상'
    </select>

    <select id="getLikeCount" resultType="_int">
        select coalesce(count(*), 0)
        from tbl_like l
                 inner join tbl_community_post_like cpl
                            on l.id = cpl.id
        where cpl.post_id = #{postId}
          and l.like_status = '정상'
    </select>

    <select id="getReplyCount" resultType="_int">
        select coalesce(count(*), 0)
        from tbl_reply r
                 inner join tbl_community_post_reply cpr
                            on r.id = cpr.id
        where cpr.post_id = #{postId}
          and r.reply_status = '정상'
    </select>

    <select id="getILike" resultType="boolean">
        SELECT CASE
                   WHEN COUNT(*) > 0 THEN TRUE
                   ELSE FALSE
                   END
        FROM   tbl_community_post_like cpl
                   JOIN   tbl_like l
                          ON     l.id             =  cpl.id
        WHERE  cpl.member_id    =  #{memberId}
          AND    cpl.post_id      =  #{postId}
          AND    l.like_status    = '정상'
    </select>

    <select id="getCommunityPost" resultType="communityPostVO">
        select   id,
                 post_content
        from     tbl_post
        where    id   =  #{postId}
    </select>

    <insert id="postPost" useGeneratedKeys="true" keyProperty="id">
        insert into tbl_post
                  (post_title, post_content)
        values    (#{postContent}, #{postContent})
    </insert>

    <insert id="postCommunityPost">
        INSERT INTO tbl_community_post (id, member_id, channel_id)
        VALUES (
                   #{postVO.id},
                   #{postVO.memberId},
                   (SELECT id FROM tbl_channel WHERE channel_url = #{channelUrl})
               );
    </insert>

    <insert id="postFile" useGeneratedKeys="true" keyProperty="id">
        insert into tbl_file
                (file_path, file_name)
        values ( #{filePath}, #{fileName})
    </insert>

    <insert id="postCommunityPostFile">
        insert into  tbl_community_post_file
                    (id,  post_id)
        values      (#{file.id}, #{postId})
    </insert>

</mapper>