<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.app.feelog.mapper.DiaryMapper">

    <insert id="insert" parameterType="com.app.feelog.domain.vo.DiaryVO" useGeneratedKeys="true" keyProperty="id">
        insert into tbl_diary (diary_title, diary_content, diary_file_path, diary_file_name, diary_file_size,diary_open,diary_name_open,diary_score, member_id)
        values (#{diaryTitle}, #{diaryContent}, #{diaryFilePath}, #{diaryFileName}, #{diaryFileSize}, #{diaryOpen}, #{diaryNameOpen}, #{diaryScore}, #{memberId})
    </insert>

    <!-- 단일 조회 -->
    <select id="selectById" resultType="com.app.feelog.domain.vo.DiaryVO">
        select
            id,
            diary_title,
            diary_content,
            diary_open,
            diary_name_open,
            diary_file_path,
            diary_file_name,
            diary_file_size,
            member_id,
            diary_status,
            created_date,
            updated_date
        from tbl_diary
        where id = #{id}
    </select>

    <!-- 수정 -->
    <update id="update" parameterType="DiaryVO">
        update tbl_diary
        set diary_title = #{diaryTitle},
            diary_content = #{diaryContent},
            diary_open = #{diaryOpen},
            diary_name_open = #{diaryNameOpen},
            diary_file_path = #{diaryFilePath},
            diary_file_name = #{diaryFileName},
            diary_file_size = #{diaryFileSize},
            diary_score = #{diaryScore},
            updated_date = NOW()
        where id = #{id}
    </update>




    <select id="getRecentDiaries" resultType="com.app.feelog.domain.dto.DiarySearchDTO">
        SELECT
            d.id,
            d.diary_title AS title,
            m.member_nickname AS nickname,
            CONCAT(d.diary_file_path, '/', d.diary_file_name) AS thumbnailUrl,
            d.created_date,
            (
                SELECT GROUP_CONCAT(t.contents)
                FROM tbl_diary_tag dt
                         JOIN tbl_tag t ON dt.id = t.id
                WHERE dt.diary_id = d.id
                  AND t.tag_status = 'ACTIVE'
            ) AS tags
        FROM tbl_diary d
                 JOIN tbl_member m ON d.member_id = m.id
        WHERE d.diary_status = '정상'
        ORDER BY d.created_date DESC
        LIMIT 10
    </select>

    <select id="searchDiaries" resultType="com.app.feelog.domain.dto.DiarySearchDTO">
        SELECT
            d.id,
            d.diary_title AS title,
            d.diary_content AS content,
            m.member_nickname AS nickname,
            CONCAT(d.diary_file_path, '/', d.diary_file_name) AS thumbnailUrl,
            CONCAT(m.member_file_path, '/', m.member_file_name) AS memberProfileImg,
            m.id AS memberId,
            d.created_date AS createdDate,
            (
                SELECT GROUP_CONCAT(t.contents)
                FROM tbl_diary_tag dt
                         JOIN tbl_tag t ON dt.id = t.id
                WHERE dt.diary_id = d.id
                  AND t.tag_status = 'ACTIVE'
            ) AS tags
        FROM tbl_diary d
                 JOIN tbl_member m ON d.member_id = m.id
                 LEFT JOIN tbl_diary_tag dt ON d.id = dt.diary_id
                 LEFT JOIN tbl_tag t ON dt.id = t.id AND t.tag_status = 'ACTIVE'
        WHERE d.diary_status = '정상'
          AND (
            d.diary_title LIKE CONCAT('%', #{keyword}, '%')
                OR d.diary_content LIKE CONCAT('%', #{keyword}, '%')
                OR t.contents LIKE CONCAT('%', #{keyword}, '%')
            )
        GROUP BY d.id, d.diary_title, m.member_nickname, d.diary_file_path, d.diary_file_name,
                 m.member_file_path, m.member_file_name, m.id, d.created_date
        ORDER BY d.created_date DESC
        LIMIT 5
    </select>

    <select id="searchMoreDiaries" resultType="com.app.feelog.domain.dto.DiarySearchDTO">
        SELECT
            d.id,
            d.diary_title AS title,
            d.diary_content AS content,
            d.diary_open AS openStatus,
            d.created_date AS createdDate,
            m.id AS memberId,
            m.member_nickname AS nickname,
            CONCAT(m.member_file_path, '/', m.member_file_name) AS memberProfileImg,
            CONCAT(d.diary_file_path, '/', d.diary_file_name) AS thumbnailUrl,
            (
                SELECT GROUP_CONCAT(t.contents)
                FROM tbl_diary_tag dt
                         JOIN tbl_tag t ON dt.id = t.id
                WHERE dt.diary_id = d.id
                  AND t.tag_status = '정상'
            ) AS tags
        FROM tbl_diary d
                 JOIN tbl_member m ON d.member_id = m.id
        WHERE d.diary_status = '정상'
          AND (
            d.diary_title LIKE CONCAT('%', #{keyword}, '%')
                OR d.diary_content LIKE CONCAT('%', #{keyword}, '%')
                OR EXISTS (
                SELECT 1
                FROM tbl_diary_tag dt
                         JOIN tbl_tag t ON dt.id = t.id
                WHERE dt.diary_id = d.id
                  AND t.tag_status = '정상'
                  AND t.contents LIKE CONCAT('%', #{keyword}, '%')
            )
            )
        ORDER BY d.created_date DESC
        LIMIT #{limit} OFFSET #{offset}
    </select>



</mapper>